<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªé¢¨ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .preview-wrapper {
            flex-grow: 1;
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            min-width: 320px;
            min-height: 240px;
            background: #222;
        }
        #zoom-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.4);
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
            border-radius: 3px;
        }
        #zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            border: 2px solid #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 10px;
        }
        .gallery-item {
            aspect-ratio: 1 / 1;
            width: 100%;
            cursor: pointer;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .gallery-item:active {
            transform: scale(0.95);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-black text-white font-sans">
    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
    <div class="preview-wrapper">
        <video id="video-preview" autoplay playsinline muted></video>
        <div id="status-message" class="absolute top-0 left-0 right-0 p-3 text-center transition-all duration-300 hidden z-20 pointer-events-none"></div>
        <div class="absolute top-4 w-full px-4 z-10">
            <div id="zoom-control-container" class="bg-gray-800/70 p-3 rounded-lg shadow-xl max-w-sm mx-auto flex items-center space-x-3 hidden">
                <span class="text-sm font-bold w-10 text-right">1x</span>
                <input type="range" id="zoom-slider" min="1.0" max="4.0" step="0.1" value="1.0">
                <span id="zoom-value-display" class="text-sm font-bold w-10 text-left">1.0x</span>
            </div>
        </div>
    </div>
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="fixed bottom-0 left-0 right-0 bg-gray-900/95 p-4 z-30 shadow-2xl">
        <div class="flex justify-center space-x-6 mb-4 text-lg font-semibold">
            <button id="mode-photo" class="px-4 py-1 rounded-full transition duration-150 border border-transparent text-blue-400 border-blue-400">å†™çœŸ</button>
            <button id="mode-record" class="px-4 py-1 rounded-full text-white/50 hover:text-white transition duration-150">éŒ²éŸ³</button>
        </div>
        <div class="flex items-center justify-between h-20">
            <button id="switch-camera-btn" class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 transition duration-150 shadow-lg disabled:opacity-30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
            <div id="photo-controls" class="flex justify-center">
                <button id="capture-image-btn" class="w-16 h-16 bg-white border-4 border-gray-400 rounded-full flex items-center justify-center transition duration-150 disabled:opacity-50 active:scale-90 hover:scale-105">
                    <div class="w-12 h-12 bg-white rounded-full border border-gray-900"></div>
                </button>
            </div>
            <div id="record-controls" class="flex justify-center hidden">
                <button id="start-recording-btn" class="w-16 h-16 bg-red-600 border-4 border-red-300 rounded-full flex items-center justify-center transition duration-150 disabled:opacity-50 active:scale-90 hover:scale-105">
                    <div class="w-12 h-12 bg-red-600 rounded-full border border-gray-900"></div>
                </button>
                <button id="stop-recording-btn" class="w-16 h-16 bg-gray-300 border-4 border-red-600 rounded-lg flex items-center justify-center transition duration-150 ml-4 disabled:opacity-50 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5h14v14H5z"/></svg>
                </button>
            </div>
            <button id="gallery-btn" class="w-12 h-12 flex items-center justify-center rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 shadow-lg">
                <span id="gallery-thumbnail" class="w-10 h-10 rounded-md bg-gray-500 flex items-center justify-center text-sm font-bold text-white overflow-hidden">
                    0
                </span>
            </button>
        </div>
    </div>
    <!-- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="gallery-modal" class="fixed inset-0 bg-black/95 z-40 hidden flex flex-col p-4">
        <div class="flex justify-between items-center pb-4 border-b border-gray-700">
            <h2 class="text-2xl font-bold">ä¿å­˜ã•ã‚ŒãŸå†™çœŸ (ã‚¿ãƒƒãƒ—ã§ä¿å­˜)</h2>
            <button id="close-gallery-btn" class="p-2 text-white hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="gallery-container" class="gallery-grid mt-4">
            <p class="text-gray-400 col-span-3 text-center">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        <p class="text-center text-sm text-gray-400 mt-4">å†™çœŸã‚’ã‚¿ãƒƒãƒ—ï¼ˆã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼‰ã™ã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
    </div>
    <!-- ã‚­ãƒ£ãƒ—ãƒãƒ£ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ (éè¡¨ç¤º) -->
    <canvas id="capture-canvas" style="display:none"></canvas>
    <script>
        // DOM
        const videoPreview = document.getElementById('video-preview');
        const captureCanvas = document.getElementById('capture-canvas');
        const statusMessage = document.getElementById('status-message');
        const zoomSlider = document.getElementById('zoom-slider');
        const zoomControlContainer = document.getElementById('zoom-control-container');
        const zoomValueDisplay = document.getElementById('zoom-value-display');
        const modePhoto = document.getElementById('mode-photo');
        const modeRecord = document.getElementById('mode-record');
        const photoControls = document.getElementById('photo-controls');
        const recordControls = document.getElementById('record-controls');
        const captureImageBtn = document.getElementById('capture-image-btn');
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        const galleryModal = document.getElementById('gallery-modal');
        const closeGalleryBtn = document.getElementById('close-gallery-btn');
        const galleryContainer = document.getElementById('gallery-container');
        const galleryThumbnail = document.getElementById('gallery-thumbnail');

        // çŠ¶æ…‹
        let currentStream = null;
        let audioRecorder = null;
        let audioChunks = [];
        let videoDevices = [];
        let currentCameraIndex = 0;
        let currentMode = 'photo'; // 'photo' or 'record'
        let capturedImages = [];
        let currentZoom = 1.0;
        const APP_NAME = 'CameraApp';

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-500', 'bg-green-600', 'bg-blue-600');
            statusMessage.classList.add('p-3', 'rounded-b-lg', 'font-bold', 'text-white', 'opacity-90');
            switch (type) {
                case 'error':
                    statusMessage.classList.add('bg-red-500');
                    break;
                case 'success':
                    statusMessage.classList.add('bg-green-600');
                    break;
                case 'info':
                default:
                    statusMessage.classList.add('bg-blue-600');
                    break;
            }
            setTimeout(() => { statusMessage.classList.add('hidden'); }, 3000);
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function switchMode(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            if (mode === 'photo') {
                photoControls.classList.remove('hidden');
                recordControls.classList.add('hidden');
                modePhoto.classList.add('border-blue-400', 'text-blue-400');
                modePhoto.classList.remove('text-white/50', 'border-transparent');
                modeRecord.classList.remove('border-red-400', 'text-red-400');
                modeRecord.classList.add('text-white/50', 'border-transparent');
                zoomControlContainer.classList.remove('hidden');
            } else {
                if (audioRecorder && audioRecorder.state === 'recording') {
                    showStatus('éŒ²éŸ³ä¸­ã¯ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
                photoControls.classList.add('hidden');
                recordControls.classList.remove('hidden');
                modeRecord.classList.add('border-red-400', 'text-red-400');
                modeRecord.classList.remove('text-white/50', 'border-transparent');
                modePhoto.classList.remove('border-blue-400', 'text-blue-400');
                modePhoto.classList.add('text-white/50', 'border-transparent');
                zoomControlContainer.classList.add('hidden');
                zoomSlider.value = 1.0;
                updateZoom();
            }
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
        function stopMediaStream(stream) {
            if (stream) { stream.getTracks().forEach(track => track.stop()); }
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function startCamera(cameraId) {
            stopMediaStream(currentStream);
            captureImageBtn.disabled = true;
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        deviceId: cameraId ? { exact: cameraId } : undefined
                    }
                };
                showStatus('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...', 'info');
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                if ('srcObject' in videoPreview) {
                    videoPreview.srcObject = currentStream;
                } else {
                    videoPreview.src = window.URL.createObjectURL(currentStream);
                }
                videoPreview.autoplay = true;
                videoPreview.playsInline = true;
                videoPreview.muted = true;

                // playã®Promiseã§æ˜ç¤ºçš„ã«ã‚¨ãƒ©ãƒ¼ã‚’catch
                videoPreview.onloadedmetadata = async () => {
                    try {
                        await videoPreview.play();
                        showStatus('ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚', 'success');
                        captureImageBtn.disabled = false;
                    } catch (playError) {
                        showStatus('ãƒ“ãƒ‡ã‚ªå†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã¿ã¦ãã ã•ã„ã€‚', 'error');
                    }
                };
            } catch (err) {
                showStatus(`ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.name} (æ¨©é™ã€ã¾ãŸã¯åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ã‚’ç¢ºèªã—ã¦ãã ã•ã„)`, 'error');
            }
        }

        async function setupCameraDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
                if (videoDevices.length === 0) {
                    showStatus('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                    switchCameraBtn.disabled = true;
                    captureImageBtn.disabled = true;
                    return;
                }
                switchCameraBtn.disabled = (videoDevices.length <= 1);
                currentCameraIndex = 0;
                await startCamera(videoDevices[currentCameraIndex].deviceId);
            } catch (err) {
                showStatus(`ãƒ‡ãƒã‚¤ã‚¹ã®åˆ—æŒ™ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.name}`, 'error');
                switchCameraBtn.disabled = true;
            }
        }

        function switchCamera() {
            if (videoDevices.length <= 1) return;
            currentCameraIndex = (currentCameraIndex + 1) % videoDevices.length;
            const nextCameraId = videoDevices[currentCameraIndex].deviceId;
            startCamera(nextCameraId);
            showStatus(`ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ: ${videoDevices[currentCameraIndex].label || 'Camera ' + (currentCameraIndex + 1)}`, 'info');
        }

        function updateZoom() {
            currentZoom = parseFloat(zoomSlider.value);
            videoPreview.style.transform = `scale(${currentZoom})`;
            zoomValueDisplay.textContent = `${currentZoom.toFixed(1)}x`;
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => { URL.revokeObjectURL(url); }, 1000);
        }

        function captureImage() {
            if (!currentStream || videoPreview.paused) {
                showStatus('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            captureCanvas.width = videoPreview.videoWidth;
            captureCanvas.height = videoPreview.videoHeight;
            const ctx = captureCanvas.getContext('2d');
            ctx.drawImage(videoPreview, 0, 0, captureCanvas.width, captureCanvas.height);
            captureCanvas.toBlob((blob) => {
                if (blob) {
                    const imageUrl = URL.createObjectURL(blob);
                    capturedImages.push({ imageUrl, blob });
                    updateGalleryThumbnail();
                    showStatus('å†™çœŸã‚’æ’®ã‚Šã¾ã—ãŸï¼', 'success');
                } else {
                    showStatus('ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                }
            }, 'image/png');
        }
        
        async function startRecording() {
            try {
                const audioConstraints = { audio: true }; 
                const audioStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                audioChunks = [];
                audioRecorder = new MediaRecorder(audioStream);
                audioRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                audioRecorder.onstop = () => {
                    stopMediaStream(audioStream);
                    const mimeType = audioChunks[0]?.type || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const extension = mimeType.split('/')[1].split(';')[0];
                    const filename = `${APP_NAME}_Audio_${timestamp}.${extension}`;
                    downloadFile(audioBlob, filename);
                    showStatus(`éŒ²éŸ³ã‚’åœæ­¢ã—ã€'${filename}'ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'success');
                    startRecordingBtn.classList.remove('hidden');
                    stopRecordingBtn.classList.add('hidden');
                };
                audioRecorder.start();
                showStatus('ğŸ”´ éŒ²éŸ³ä¸­...', 'info');
                startRecordingBtn.classList.add('hidden');
                stopRecordingBtn.classList.remove('hidden');
            } catch (err) {
                showStatus(`éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.name} (ãƒã‚¤ã‚¯æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„)`, 'error');
            }
        }

        function stopRecording() {
            if (audioRecorder && audioRecorder.state === 'recording') {
                audioRecorder.stop();
            }
        }

        function updateGalleryThumbnail() {
            if (capturedImages.length > 0) {
                const latestImage = capturedImages[capturedImages.length - 1];
                galleryThumbnail.style.backgroundImage = `url(${latestImage.imageUrl})`;
                galleryThumbnail.style.backgroundSize = 'cover';
                galleryThumbnail.style.backgroundPosition = 'center';
                galleryThumbnail.textContent = '';
                galleryThumbnail.classList.remove('bg-gray-500');
            } else {
                galleryThumbnail.style.backgroundImage = 'none';
                galleryThumbnail.textContent = '0';
                galleryThumbnail.classList.add('bg-gray-500');
            }
        }

        function openGallery() {
            galleryModal.classList.remove('hidden');
            galleryContainer.innerHTML = '';
            if (capturedImages.length === 0) {
                galleryContainer.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-10">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            const imagesToShow = [...capturedImages].reverse();
            imagesToShow.forEach((imgData) => { 
                const imgElement = document.createElement('img');
                imgElement.src = imgData.imageUrl;
                imgElement.alt = 'Captured Image';
                imgElement.classList.add('gallery-item');
                imgElement.addEventListener('click', () => {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `${APP_NAME}_GalleryImage_${timestamp}.png`;
                    downloadFile(imgData.blob, filename);
                    showStatus(`å†™çœŸã‚’ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã—ã¾ã—ãŸ: ${filename}`, 'success');
                });
                galleryContainer.appendChild(imgElement);
            });
        }

        function closeGallery() {
            galleryModal.classList.add('hidden');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆ
        modePhoto.addEventListener('click', () => switchMode('photo'));
        modeRecord.addEventListener('click', () => switchMode('record'));
        switchCameraBtn.addEventListener('click', switchCamera);
        zoomSlider.addEventListener('input', updateZoom);
        captureImageBtn.addEventListener('click', captureImage);
        startRecordingBtn.addEventListener('click', startRecording);
        stopRecordingBtn.addEventListener('click', stopRecording);
        galleryBtn.addEventListener('click', openGallery);
        closeGalleryBtn.addEventListener('click', closeGallery);

        // iOSã‚„ä¸€éƒ¨ç«¯æœ«ã§audio/videoè‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šå¤±æ•—ã™ã‚‹å ´åˆã®ãƒªã‚«ãƒãƒ¼
        videoPreview.addEventListener('click', async () => {
            if (videoPreview.srcObject && videoPreview.paused) {
                try {
                    await videoPreview.play();
                    showStatus('ãƒ“ãƒ‡ã‚ªã®å†ç”Ÿã‚’è©¦è¡Œã—ã¾ã—ãŸã€‚', 'success');
                } catch (e) {}
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupCameraDevices();
            switchMode('photo');
            updateZoom();
            updateGalleryThumbnail();
        });
    </script>
</body>
</html>
